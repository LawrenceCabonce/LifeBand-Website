<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeBand - Chat Support</title>
    <link rel="stylesheet" href="navbar.css">
    <link rel="stylesheet" href="Chat_Support.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-left">
            <img src="lifeband-text-logo.png" alt="LifeBand" class="logo">
        </div>
        <ul class="nav-menu">
            <li><a href="Homepage.html" class="nav-link">Home</a></li>
            <li><a href="Dev_info.html" class="nav-link">Device information</a></li>
            <li><a href="About_us.html" class="nav-link">About Us</a></li>
            <li><a href="Contact.html" class="nav-link">Contact</a></li>
            <li id="adminPanelLink" style="display:none;"><a href="Admin_Control_Panel.php" class="nav-link">Admin Panel</a></li>
        </ul>
        <div class="nav-right">
            <div id="userProfile" class="user-profile-wrapper" style="display:none;">
                <img id="profilePic" src="profile_pic.jpg" alt="Profile" class="profile-pic-nav">
                <span id="userName" class="user-name-text"></span>
            </div>
            <button class="signin-btn">Sign in</button>
            <button class="hamburger-menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </nav>

    <!-- User Profile -->
    <div id="userProfileModal" class="profile-modal" style="display:none;">
        <div class="profile-modal-content">
            <button class="profile-modal-close">&times;</button>
            <div class="profile-modal-header">
                <img id="modalProfilePic" src="profile_pic.jpg" alt="Profile Picture" class="profile-modal-pic">
            </div>
            <div class="profile-modal-body">
                <div class="profile-info-group">
                    <label>Name</label>
                    <p id="modalUserName">-</p>
                </div>
                <div class="profile-info-group">
                    <label>Role</label>
                    <p id="modalUserRole">-</p>
                </div>
                <div class="profile-info-group">
                    <label>Email</label>
                    <p id="modalUserEmail">-</p>
                </div>
                <div class="profile-info-group">
                    <label>Region</label>
                    <p id="modalUserRegion">-</p>
                </div>
                <div class="profile-info-group">
                    <label>Date of Birth</label>
                    <p id="modalUserDOB">-</p>
                </div>
            </div>
            <div class="profile-modal-footer">
                <button class="edit-profile-btn">Edit Profile</button>
                <button class="logout-btn">Logout</button>
            </div>
        </div>
    </div>

    <!-- Header Section -->
    <div class="page-header">
        <div class="header-content">
            <h1>Lifeband Chat Support</h1>
        </div>
        <div class="header-controls">
            <button class="back-btn">‚ü≤</button>
            <button class="close-btn">‚úï</button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="chat-container">
            <!-- Login Check Message -->
            <div id="loginMessage" style="display:none; padding: 20px; text-align: center; color: #999;">
                <p>Please <a href="index.html">sign in</a> to use chat support.</p>
            </div>

            <!-- Chat Messages Area -->
            <div id="chatArea" style="display:none;">
                <div class="chat-messages" id="chatMessages">
                    <div class="bot-greeting">
                        <div class="bot-avatar">üë©‚Äçüíº</div>
                        <div class="greeting-bubble">
                            <p>How can I assist you today?</p>
                        </div>
                    </div>
                </div>

                <p class="reply-message">Typically replies in a few minutes</p>

                <div class="chat-input-section">
                    <input type="text" id="chatInput" class="chat-input" placeholder="Type your message...">
                    <button id="sendBtn" class="send-btn">‚û§</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        let currentUserId = null;
        let lastMessageCount = 0;

        // Function to show/hide admin link based on role
        function updateAdminLink() {
            const userRole = localStorage.getItem('userRole');
            const adminPanelLink = document.getElementById('adminPanelLink');
            if (adminPanelLink) {
                if (userRole && userRole.toLowerCase() === 'admin') {
                    adminPanelLink.style.display = 'block';
                } else {
                    adminPanelLink.style.display = 'none';
                }
            }
        }

        // Check if user is logged in
        const userName = localStorage.getItem('userName');
        const userRole = localStorage.getItem('userRole');
        const userEmail = localStorage.getItem('userEmail');
        const userRegion = localStorage.getItem('userRegion');
        const userDOB = localStorage.getItem('userDOB');

        if (userName) {
            document.getElementById('userName').textContent = userName;
            document.getElementById('userProfile').style.display = 'flex';
            document.querySelector('.signin-btn').style.display = 'none';
            document.getElementById('chatArea').style.display = 'block';
            document.getElementById('loginMessage').style.display = 'none';
            updateAdminLink();
            
            // Load chat messages
            loadChatMessages();
            // Refresh messages every 3 seconds
            setInterval(loadChatMessages, 3000);
        } else {
            document.getElementById('loginMessage').style.display = 'block';
            document.getElementById('chatArea').style.display = 'none';
        }

        const urlParams = new URLSearchParams(window.location.search);
        const user = urlParams.get('user');
        if (user) {
            localStorage.setItem('userName', user);
            localStorage.setItem('userEmail', urlParams.get('email') || '');
            localStorage.setItem('userRegion', urlParams.get('region') || '');
            localStorage.setItem('userDOB', urlParams.get('dob') || '');
            localStorage.setItem('userRole', urlParams.get('role') || '');
            window.history.replaceState(null, null, window.location.pathname);
            // Show the profile and chat
            document.getElementById('userName').textContent = user;
            document.getElementById('userProfile').style.display = 'flex';
            document.querySelector('.signin-btn').style.display = 'none';
            document.getElementById('chatArea').style.display = 'block';
            document.getElementById('loginMessage').style.display = 'none';
            updateAdminLink();
            
            // Load chat messages
            loadChatMessages();
            // Refresh messages every 3 seconds
            setInterval(loadChatMessages, 3000);
            document.getElementById('userName').textContent = user;
            document.getElementById('userProfile').style.display = 'flex';
            document.querySelector('.signin-btn').style.display = 'none';
            document.getElementById('chatArea').style.display = 'block';
            document.getElementById('loginMessage').style.display = 'none';
            loadChatMessages();
            setInterval(loadChatMessages, 3000);
        }

        // Load chat messages from backend
        function loadChatMessages() {
            fetch('support.php?action=fetch')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const messagesContainer = document.getElementById('chatMessages');
                        currentUserId = data.current_acc_id;
                        
                        // Clear and rebuild messages
                        messagesContainer.innerHTML = '<div class="bot-greeting"><div class="bot-avatar">üë©‚Äçüíº</div><div class="greeting-bubble"><p>How can I assist you today?</p></div></div>';
                        
                        data.messages.forEach(msg => {
                            const messageDiv = document.createElement('div');
                            messageDiv.className = msg.is_admin_reply ? 'message admin-message' : 'message user-message';
                            
                            const senderSpan = document.createElement('span');
                            senderSpan.className = 'message-sender';
                            senderSpan.textContent = msg.sender_name + ' - ' + msg.msg_date;
                            
                            const textSpan = document.createElement('span');
                            textSpan.className = 'message-text';
                            textSpan.textContent = msg.msg_text;
                            
                            messageDiv.appendChild(senderSpan);
                            messageDiv.appendChild(textSpan);
                            messagesContainer.appendChild(messageDiv);
                        });
                        
                        // Auto-scroll to bottom
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                })
                .catch(error => console.error('Error loading messages:', error));
        }

        // Send message
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            const formData = new FormData();
            formData.append('action', 'send');
            formData.append('message', message);
            
            fetch('support.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    input.value = '';
                    loadChatMessages();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => console.error('Error sending message:', error));
        }

        // Send button click
        document.getElementById('sendBtn').addEventListener('click', sendMessage);

        // Enter key to send
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // User Profile Modal functionality
        const userProfileWrapper = document.getElementById('userProfile');
        const userProfileModal = document.getElementById('userProfileModal');
        const profileModalClose = document.querySelector('.profile-modal-close');
        const logoutBtn = document.querySelector('.logout-btn');
        const editProfileBtn = document.querySelector('.edit-profile-btn');

        if (userProfileWrapper) {
            userProfileWrapper.addEventListener('click', function() {
                userProfileModal.style.display = 'flex';
                // Populate modal with user data
                document.getElementById('modalUserName').textContent = localStorage.getItem('userName') || '-';
                document.getElementById('modalUserRole').textContent = localStorage.getItem('userRole') || '-';
                document.getElementById('modalUserEmail').textContent = localStorage.getItem('userEmail') || '-';
                document.getElementById('modalUserRegion').textContent = localStorage.getItem('userRegion') || '-';
                document.getElementById('modalUserDOB').textContent = localStorage.getItem('userDOB') || '-';
            });
        }

        profileModalClose.addEventListener('click', function() {
            userProfileModal.style.display = 'none';
        });

        userProfileModal.addEventListener('click', function(e) {
            if (e.target === userProfileModal) {
                userProfileModal.style.display = 'none';
            }
        });

        logoutBtn.addEventListener('click', function() {
            localStorage.clear();
            window.location.href = 'index.html';
        });

        editProfileBtn.addEventListener('click', function() {
            window.location.href = 'Account_Edit.html';
        });

        // Sign in button
        document.querySelector('.signin-btn').addEventListener('click', function() {
            window.location.href = 'index.html';
        });

        // Back button
        document.querySelector('.back-btn').addEventListener('click', function() {
            window.history.back();
        });

        // Close button
        document.querySelector('.close-btn').addEventListener('click', function() {
            window.location.href = 'Homepage.html';
        });

        // Hamburger menu toggle
        document.querySelector('.hamburger-menu').addEventListener('click', function() {
            document.querySelector('.nav-menu').classList.toggle('active');
        });
    </script>
</body>
</html>
